<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codes Hub | Proje Paylaşım Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        /* Color Variables - Light Theme (Default) */
        :root {
            --primary-color: #3b82f6; /* Blue */
            --secondary-color: #f97316; /* Orange */
            --text-default: #1f2937;
            --text-secondary: #4b5563;
            --bg-default: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Color Variables - Dark Theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #38bdf8; /* Light Blue */
                --secondary-color: #f97316; /* Orange */
                --text-default: #f3f4f6;
                --text-secondary: #9ca3af;
                --bg-default: #1f2937;
                --card-bg: #374151;
                --border-color: #4b5563;
                --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-default);
            color: var(--text-default);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-glow);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-field {
            background-color: var(--bg-default);
            border: 1px solid var(--border-color);
            color: var(--text-default);
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            outline: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 80%, black);
            transform: scale(1.02);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 80%, black);
            transform: scale(1.02);
        }

        /* Scratch Player styles */
        #scratch-player-container {
            width: 100%;
            padding-top: 75%; /* 4:3 aspect ratio (480/640 = 0.75) */
            position: relative;
            background-color: var(--bg-default);
        }

        #scratch-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 50;
        }

        .modal-content {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-glow);
            z-index: 51;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Ana Konteyner -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Başlık ve Durum Çubuğu -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-border-color">
            <div class="flex items-center space-x-3">
                <img src="logo.svg" alt="Codes Hub Logo" class="h-10 w-auto">
            </div>
            <div class="mt-4 sm:mt-0 text-right text-sm font-medium text-text-secondary flex items-center space-x-3">
                <span id="auth-status" class="text-xs text-secondary-color font-bold">Yükleniyor...</span>
                <span id="user-info" class="p-1 rounded-md bg-primary-color/10 text-primary-color text-xs">
                    Kullanıcı ID: Yükleniyor...
                </span>
            </div>
        </header>

        <!-- Ana İçerik Izgarası -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Sol Sütun: Proje Yükleme ve Önizleme -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Proje Yükleme Formu -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="upload" class="w-6 h-6 mr-3"></i>Yeni Proje Paylaş
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Scratch / TurboWarp URL'si:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="project-url" placeholder="Örn: https://scratch.mit.edu/projects/123456789/"
                                       class="input-field w-full p-2.5 rounded-xl text-sm">
                                <button id="load-project-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="loadProject()">
                                    Projeyi Yükle
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Proje Başlığı:</label>
                            <input type="text" id="project-title" placeholder="Harika Platform Oyunum"
                                   class="input-field w-full p-2.5 rounded-xl text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Açıklama:</label>
                            <textarea id="project-description" rows="3" placeholder="Bu oyunda uzaylılardan kaçıyorsunuz. Hareket etmek için WASD kullanın."
                                      class="input-field w-full p-2.5 rounded-xl text-sm resize-none"></textarea>
                        </div>
                        <button id="share-project-btn" class="btn-secondary text-white font-bold py-3 w-full rounded-xl mt-4" onclick="shareProject()" disabled>
                            Codes Hub'da Paylaş
                        </button>
                    </div>
                </div>

                <!-- Proje Önizlemesi -->
                <div class="card p-4 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="monitor-play" class="w-6 h-6 mr-3"></i>Proje Önizlemesi
                    </h2>
                    <div id="scratch-player-container" class="bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden shadow-inner">
                        <p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-text-secondary/70 text-center p-8">
                            Önizlemeyi görmek için yukarıya bir Scratch/TurboWarp URL'si girin ve 'Projeyi Yükle' butonuna tıklayın.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Sağ Sütun: Sohbet ve Projeler Akışı -->
            <div class="lg:col-span-1 space-y-8">

                <!-- Topluluk Sohbeti -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-secondary-color mb-4 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-3"></i>Topluluk Sohbeti
                    </h2>
                    <div id="chat-messages" class="h-64 overflow-y-auto space-y-3 p-3 rounded-xl bg-bg-default border border-border-color mb-4 text-sm">
                        <!-- Mesajlar buraya yüklenecek -->
                        <p class="text-text-secondary/80 italic text-center">Mesajlar yükleniyor...</p>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Bir mesaj yazın..."
                               class="input-field w-full p-2.5 rounded-xl text-sm" disabled>
                        <button id="send-chat-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="sendMessage()" disabled>
                            Gönder
                        </button>
                    </div>
                    <p id="chat-error" class="text-xs mt-2 text-text-secondary">Sohbet etmek için bir takma ad belirlemelisiniz.</p>
                </div>

                <!-- Paylaşılan Projeler Akışı -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="layers-3" class="w-6 h-6 mr-3"></i>Paylaşılan Projeler
                    </h2>
                    <div id="projects-feed" class="space-y-4 h-[300px] overflow-y-auto">
                        <p class="text-text-secondary/80 italic text-center">Projeler yükleniyor...</p>
                    </div>
                </div>

                <!-- Moderatör Paneli -->
                <div id="moderation-panel" class="card p-6 rounded-2xl bg-red-500/10 border-red-500/30 hidden">
                    <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-2"></i>Moderatör Kontrol Paneli
                    </h2>
                    <p class="text-sm text-text-secondary mb-3">Yasaklamak veya yasağı kaldırmak için kullanıcının UID'sini girin.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="ban-uid-input" placeholder="Kullanıcı UID'si" class="input-field w-full p-2 rounded-xl text-sm bg-red-500/5">
                        <button id="ban-user-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-red-700" onclick="banUser(document.getElementById('ban-uid-input').value)">
                            Yasakla
                        </button>
                        <button id="unban-user-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-green-700" onclick="unbanUser(document.getElementById('ban-uid-input').value)">
                            Yasağı Kaldır
                        </button>
                    </div>
                    <div id="banned-users-list" class="mt-4 text-xs text-text-secondary">
                        <!-- Yasaklı UID'ler buraya yüklenecek -->
                        Yasaklı kullanıcı listesi yükleniyor...
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Modal Konteynerları -->

    <!-- 1. Takma Ad Modalı (Giriş/Kayıt) -->
    <div id="nickname-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-md p-6 rounded-2xl text-center">
            <h3 class="text-2xl font-bold text-primary-color mb-4">Takma Adınızı Belirleyin</h3>
            <p class="text-sm text-text-secondary mb-6">
                Codes Hub'a katılmak ve toplulukla sohbet etmek için bir takma ad gereklidir.
            </p>
            <input type="text" id="nickname-input" placeholder="Takma Adınız" class="input-field w-full p-3 rounded-xl mb-4 text-center text-base">
            <button id="save-nickname-btn" class="btn-primary text-white font-bold py-3 w-full rounded-xl" onclick="saveNickname()">
                Kaydet ve Katıl
            </button>
            <p class="text-xs text-text-secondary mt-3">
                Not: Moderatör yetkilerini kullanmak için giriş yaptığınız yer de burasıdır.
            </p>
        </div>
    </div>

    <!-- 2. Genel Mesaj Modalı (Alert/Confirm yerine) -->
    <div id="message-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 id="msg-title" class="text-xl font-bold text-text-default mb-3">Başlık</h3>
            <p id="msg-body" class="text-sm text-text-secondary mb-6"></p>
            <div id="msg-actions" class="flex justify-center space-x-3">
                <button id="msg-confirm" class="btn-secondary text-white font-semibold py-2 px-4 rounded-xl" onclick="closeMessageModal(true)">
                    Onayla
                </button>
                <button id="msg-cancel" class="bg-gray-300 text-text-default font-semibold py-2 px-4 rounded-xl hover:bg-gray-400" onclick="closeMessageModal(false)">
                    İptal Et
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports ve JS Mantığı -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel, arrayUnion, arrayRemove, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables
        let app, auth, db;
        let currentUserId = null;
        let currentUserNickname = null;
        let isModerator = false;
        let bannedUids = [];

        // Örnek Takma Adlar (Placeholder için)
        const EXAMPLE_NICKNAMES = ["KodBüyücüsü", "PikselPilot", "ScratchKralı", "BlokUstası", "KodcuKedi"];

        // Moderatör isimleri (izin kontrolü için kullanılır)
        const MODERATOR_NAMES = ["EmirSeyfOS", "ScratchyXPlus", "ScratchMaster"];

        // UI Elemanları
        const authStatusEl = document.getElementById('auth-status');
        const userInfoEl = document.getElementById('user-info');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatErrorEl = document.getElementById('chat-error');
        const moderationPanel = document.getElementById('moderation-panel');
        const projectsFeed = document.getElementById('projects-feed');
        const chatMessagesEl = document.getElementById('chat-messages');

        // --- GLOBAL YAPILANDIRMA ALIMI ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'codes-hub-default';

        // Genel koleksiyon yolu yardımcısı
        const publicCollectionPath = (collectionName) => `/artifacts/${APP_ID}/public/data/${collectionName}`;

        // --- MODAL FONKSİYONLARI (Alert/Confirm yerine) ---

        let modalResolve;
        function showMessageModal(title, body, type = 'alert') { // type: 'alert' | 'confirm'
            document.getElementById('msg-title').textContent = title;
            document.getElementById('msg-body').textContent = body;
            
            const confirmBtn = document.getElementById('msg-confirm');
            const cancelBtn = document.getElementById('msg-cancel');

            if (type === 'confirm') {
                confirmBtn.textContent = 'Onayla';
                cancelBtn.classList.remove('hidden');
                return new Promise(resolve => {
                    modalResolve = resolve;
                    document.getElementById('message-modal').classList.remove('hidden');
                    document.getElementById('message-modal').classList.add('flex');
                });
            } else {
                confirmBtn.textContent = 'Kapat';
                cancelBtn.classList.add('hidden');
                document.getElementById('message-modal').classList.remove('hidden');
                document.getElementById('message-modal').classList.add('flex');
                // Basit uyarılar için herhangi bir şey beklemeye gerek yok.
            }
        }

        function closeMessageModal(result) {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }


        // --- FIREBASE BAŞLATMA VE DOĞRULAMA ---

        const initFirebase = async () => {
            setLogLevel('Debug');
            
            // Kritik Kontrol: Yapılandırma dizisinin var olduğundan emin olun
            if (typeof __firebase_config === 'undefined' || __firebase_config.length === 0) {
                authStatusEl.textContent = "Hata: Firebase Yapılandırması Eksik.";
                console.error("FATAL: __firebase_config is missing or empty.");
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = "Firebase'e Bağlanılıyor...";

                // Durum değişiklikleri için dinleyiciyi AYARLAYIN (UYGULAMANIN ANA GİRİŞ NOKTASI)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userInfoEl.textContent = `Kullanıcı ID: ${currentUserId}`;
                        console.log(`Doğrulama başarılı. Kullanıcı UID: ${currentUserId}`);
                        
                        // Kullanıcı verilerini ve moderatör durumunu yükle
                        await loadUserInfo(); 
                        
                        // Yasaklanma durumunu kontrol et
                        if (!isUserBanned(currentUserId)) {
                            enableChat();
                        } else {
                            disableChat("Yasaklandınız.");
                        }

                        // Moderatör panelini göster/gizle
                        if (isModerator) {
                            moderationPanel.classList.remove('hidden');
                        } else {
                            moderationPanel.classList.add('hidden');
                        }
                        
                        // Sohbet ve projeler için gerçek zamanlı dinleyicileri başlat
                        setupListeners();

                    } else {
                        // Kullanıcı oturumu kapattı veya giriş başarısız oldu
                        console.log("Doğrulama durumu değişti: Kullanıcı null (çıkış yapıldı veya başarısız).");
                        currentUserId = null;
                        currentUserNickname = null;
                        is
