<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codes Hub | Scratchten Daha Ä°yi Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        /* Color Variables - Light Theme (Default) */
        :root {
            --primary-color: #3b82f6; /* Blue */
            --secondary-color: #f97316; /* Orange */
            --text-default: #1f2937;
            --text-secondary: #4b5563;
            --bg-default: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Color Variables - Dark Theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #38bdf8; /* Light Blue */
                --secondary-color: #f97316; /* Orange */
                --text-default: #f3f4f6;
                --text-secondary: #9ca3af;
                --bg-default: #1f2937;
                --card-bg: #374151;
                --border-color: #4b5563;
                --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-default);
            color: var(--text-default);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-glow);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-field {
            background-color: var(--bg-default);
            border: 1px solid var(--border-color);
            color: var(--text-default);
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            outline: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 80%, black);
            transform: scale(1.02);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 80%, black);
            transform: scale(1.02);
        }

        /* Scratch Player styles */
        #scratch-player-container {
            width: 100%;
            padding-top: 75%; /* 4:3 aspect ratio (480/640 = 0.75) */
            position: relative;
            background-color: var(--bg-default);
        }

        #scratch-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 50;
        }

        .modal-content {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-glow);
            z-index: 51;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Container -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header and Status Bar -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-border-color">
            <div class="flex items-center space-x-3">
                <img src="logo.svg" alt="Codes Hub Logo" class="h-10 w-auto">
            </div>
            <div class="mt-4 sm:mt-0 text-right text-sm font-medium text-text-secondary flex items-center space-x-3">
                <span id="auth-status" class="text-xs text-secondary-color font-bold">Loading...</span>
                <span id="user-info" class="p-1 rounded-md bg-primary-color/10 text-primary-color text-xs">
                    User ID: Loading...
                </span>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Project Upload and Preview -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Project Upload Form -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="upload" class="w-6 h-6 mr-3"></i>Share New Project
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Scratch / TurboWarp URL:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="project-url" placeholder="E.g.: https://scratch.mit.edu/projects/123456789/"
                                       class="input-field w-full p-2.5 rounded-xl text-sm">
                                <button id="load-project-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="loadProject()">
                                    Load Project
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Project Title:</label>
                            <input type="text" id="project-title" placeholder="My Awesome Platformer Game"
                                   class="input-field w-full p-2.5 rounded-xl text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Description:</label>
                            <textarea id="project-description" rows="3" placeholder="In this game, you escape aliens. Use WASD to move."
                                      class="input-field w-full p-2.5 rounded-xl text-sm resize-none"></textarea>
                        </div>
                        <button id="share-project-btn" class="btn-secondary text-white font-bold py-3 w-full rounded-xl mt-4" onclick="shareProject()" disabled>
                            Share on Codes Hub
                        </button>
                    </div>
                </div>

                <!-- Project Preview -->
                <div class="card p-4 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="monitor-play" class="w-6 h-6 mr-3"></i>Project Preview
                    </h2>
                    <div id="scratch-player-container" class="bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden shadow-inner">
                        <p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-text-secondary/70 text-center p-8">
                            Enter a Scratch/TurboWarp URL above and click 'Load Project' to see the preview.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Chat and Projects Feed -->
            <div class="lg:col-span-1 space-y-8">

                <!-- Community Chat -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-secondary-color mb-4 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-3"></i>Community Chat
                    </h2>
                    <div id="chat-messages" class="h-64 overflow-y-auto space-y-3 p-3 rounded-xl bg-bg-default border border-border-color mb-4 text-sm">
                        <!-- Messages will load here -->
                        <p class="text-text-secondary/80 italic text-center">Messages loading...</p>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Type a message..."
                               class="input-field w-full p-2.5 rounded-xl text-sm" disabled>
                        <button id="send-chat-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="sendMessage()" disabled>
                            Send
                        </button>
                    </div>
                    <p id="chat-error" class="text-xs mt-2 text-text-secondary">You must set a nickname to chat.</p>
                </div>

                <!-- Shared Projects Feed -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="layers-3" class="w-6 h-6 mr-3"></i>Shared Projects
                    </h2>
                    <div id="projects-feed" class="space-y-4 h-[300px] overflow-y-auto">
                        <p class="text-text-secondary/80 italic text-center">Projects loading...</p>
                    </div>
                </div>

                <!-- Moderation Panel (For Moderators Only) -->
                <div id="moderation-panel" class="card p-6 rounded-2xl bg-red-500/10 border-red-500/30 hidden">
                    <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-2"></i>Moderator Control Panel
                    </h2>
                    <p class="text-sm text-text-secondary mb-3">Enter the user's UID to ban or unban.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="ban-uid-input" placeholder="User UID" class="input-field w-full p-2 rounded-xl text-sm bg-red-500/5">
                        <button id="ban-user-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-red-700" onclick="banUser(document.getElementById('ban-uid-input').value)">
                            Ban
                        </button>
                        <button id="unban-user-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-green-700" onclick="unbanUser(document.getElementById('ban-uid-input').value)">
                            Unban
                        </button>
                    </div>
                    <div id="banned-users-list" class="mt-4 text-xs text-text-secondary">
                        <!-- Banned UIDs will load here -->
                        Banned users list loading...
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Modal Containers -->

    <!-- 1. Nickname Modal (Sign-in/Register) -->
    <div id="nickname-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-md p-6 rounded-2xl text-center">
            <h3 class="text-2xl font-bold text-primary-color mb-4">Set Your Nickname</h3>
            <p class="text-sm text-text-secondary mb-6">
                A nickname is required to join Codes Hub and chat with the community.
            </p>
            <input type="text" id="nickname-input" placeholder="Your Nickname" class="input-field w-full p-3 rounded-xl mb-4 text-center text-base">
            <button id="save-nickname-btn" class="btn-primary text-white font-bold py-3 w-full rounded-xl" onclick="saveNickname()">
                Save and Join
            </button>
            <p class="text-xs text-text-secondary mt-3">
                Note: This is also where you sign in to use moderator privileges.
            </p>
        </div>
    </div>

    <!-- 2. General Message Modal (Instead of Alert/Confirm) -->
    <div id="message-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 id="msg-title" class="text-xl font-bold text-text-default mb-3">Title</h3>
            <p id="msg-body" class="text-sm text-text-secondary mb-6"></p>
            <div id="msg-actions" class="flex justify-center space-x-3">
                <button id="msg-confirm" class="btn-secondary text-white font-semibold py-2 px-4 rounded-xl" onclick="closeMessageModal(true)">
                    Confirm
                </button>
                <button id="msg-cancel" class="bg-gray-300 text-text-default font-semibold py-2 px-4 rounded-xl hover:bg-gray-400" onclick="closeMessageModal(false)">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel, arrayUnion, arrayRemove, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables
        let app, auth, db;
        let currentUserId = null;
        let currentUserNickname = null;
        let isModerator = false;
        let bannedUids = [];

        // Example Nicknames (for Placeholder)
        const EXAMPLE_NICKNAMES = ["CodeWizard", "PixelPilot", "ScratchKing", "BlockMaster", "CoderCat"];

        // Moderator names (used for checking permissions)
        const MODERATOR_NAMES = ["EmirSeyfOS", "ScratchyXPlus", "ScratchMaster"];

        // UI Elements
        const authStatusEl = document.getElementById('auth-status');
        const userInfoEl = document.getElementById('user-info');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatErrorEl = document.getElementById('chat-error');
        const moderationPanel = document.getElementById('moderation-panel');
        const projectsFeed = document.getElementById('projects-feed');
        const chatMessagesEl = document.getElementById('chat-messages');

        // --- GLOBAL CONFIGURATION RETRIEVAL ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'codes-hub-default';

        // Helper to get public collection path
        const publicCollectionPath = (collectionName) => `/artifacts/${APP_ID}/public/data/${collectionName}`;

        // --- MODAL FUNCTIONS (In place of Alert/Confirm) ---

        let modalResolve;
        function showMessageModal(title, body, type = 'alert') { // type: 'alert' | 'confirm'
            document.getElementById('msg-title').textContent = title;
            document.getElementById('msg-body').textContent = body;
            
            const confirmBtn = document.getElementById('msg-confirm');
            const cancelBtn = document.getElementById('msg-cancel');

            if (type === 'confirm') {
                confirmBtn.textContent = 'Confirm';
                cancelBtn.classList.remove('hidden');
                return new Promise(resolve => {
                    modalResolve = resolve;
                    document.getElementById('message-modal').classList.remove('hidden');
                    document.getElementById('message-modal').classList.add('flex');
                });
            } else {
                confirmBtn.textContent = 'Close';
                cancelBtn.classList.add('hidden');
                document.getElementById('message-modal').classList.remove('hidden');
                document.getElementById('message-modal').classList.add('flex');
                // For simple alerts, we don't need to await anything.
            }
        }

        function closeMessageModal(result) {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        const initFirebase = async () => {
            setLogLevel('Debug');
            
            // Critical Check: Ensure config string exists
            if (typeof __firebase_config === 'undefined' || __firebase_config.length === 0) {
                authStatusEl.textContent = "Error: Missing Firebase Configuration.";
                console.error("FATAL: __firebase_config is missing or empty.");
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = "Connecting to Firebase...";

                // Perform initial sign-in using the provided token or anonymously
                let userPromise;
                if (initialAuthToken) {
                    console.log("Attempting sign-in with Custom Token.");
                    userPromise = signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Attempting Anonymous sign-in.");
                    userPromise = signInAnonymously(auth);
                }

                // Wait for the sign-in operation to complete
                await userPromise;
                authStatusEl.textContent = "Sign-in successful, loading user data...";


                // Set up the listener for state changes (this is the primary entry point for the app logic)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userInfoEl.textContent = `User ID: ${currentUserId}`;
                        console.log(`Auth successful. User UID: ${currentUserId}`);
                        
                        // Load user data and moderation status
                        await loadUserInfo(); 
                        
                        // Check for ban status
                        if (!isUserBanned(currentUserId)) {
                            enableChat();
                        } else {
                            disableChat("You are banned.");
                        }

                        // Show/Hide Moderator panel
                        if (isModerator) {
                            moderationPanel.classList.remove('hidden');
                        } else {
                            moderationPanel.classList.add('hidden');
                        }
                        
                        // Start real-time listeners for chat and projects
                        setupListeners();

                    } else {
                        // User signed out or failed to sign in
                        console.log("Auth state changed: User is null (signed out or failed).");
                        currentUserId = null;
                        currentUserNickname = null;
                        isModerator = false;
                        userInfoEl.textContent = "Guest";
                        authStatusEl.textContent = "Signed Out";
                        disableChat("Signed Out");
                    }
                });
                
            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                authStatusEl.textContent = "Error: Sign-in Failed. Check Console.";
                showMessageModal("Error", `Initialization or Sign-in failed: ${error.message}`, 'alert');
            }
        };

        // --- USER INFO AND MODERATION ---

        const loadUserInfo = async () => {
            if (!currentUserId) return;

            // 1. Load Nickname
            const nicknameDocRef = doc(db, publicCollectionPath('usernames'), currentUserId);
            const nicknameDoc = await getDoc(nicknameDocRef);

            if (nicknameDoc.exists()) { // CRITICAL FIX: Use .exists() for DocumentSnapshot
                currentUserNickname = nicknameDoc.data().nickname;
                // Check for moderator status
                isModerator = MODERATOR_NAMES.includes(currentUserNickname);
                authStatusEl.textContent = isModerator ? `Moderator: ${currentUserNickname}` : `Welcome, ${currentUserNickname}`;
            } else {
                // If no nickname, show the modal
                showNicknameModal();
            }

            // 2. Load Banned User List (initial check, listener handles updates)
            const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
            const banDoc = await getDoc(banDocRef);
            
            if (banDoc.exists()) {
                bannedUids = banDoc.data().uids || [];
            } else {
                // Create document if it doesn't exist
                await setDoc(banDocRef, { uids: [] });
            }

            updateBannedListUI();
        };

        const isUserBanned = (uid) => bannedUids.includes(uid);

        const showNicknameModal = () => {
            const randomPlaceholder = EXAMPLE_NICKNAMES[Math.floor(Math.random() * EXAMPLE_NICKNAMES.length)];
            document.getElementById('nickname-input').placeholder = randomPlaceholder;
            document.getElementById('nickname-modal').classList.remove('hidden');
            document.getElementById('nickname-modal').classList.add('flex');
        };

        const saveNickname = async () => {
            const nicknameInput = document.getElementById('nickname-input');
            const nickname = nicknameInput.value.trim();

            if (nickname.length < 3 || nickname.length > 20) {
                showMessageModal("Error", "Nickname must be between 3 and 20 characters.", 'alert');
                return;
            }

            try {
                const nicknameDocRef = doc(db, publicCollectionPath('usernames'), currentUserId);
                await setDoc(nicknameDocRef, { nickname: nickname, uid: currentUserId, createdAt: serverTimestamp() });
                
                currentUserNickname = nickname;
                isModerator = MODERATOR_NAMES.includes(nickname);

                document.getElementById('nickname-modal').classList.add('hidden');
                document.getElementById('nickname-modal').classList.remove('flex');
                
                if (!isUserBanned(currentUserId)) {
                    enableChat();
                }

                authStatusEl.textContent = isModerator ? `Moderator: ${currentUserNickname}` : `Welcome, ${currentUserNickname}`;

            } catch (error) {
                console.error("Nickname save error:", error);
                showMessageModal("Error", "Could not save nickname. Please try again.", 'alert');
            }
        };
        
        const enableChat = () => {
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatErrorEl.textContent = `Joined chat as ${currentUserNickname}.`;
            chatErrorEl.classList.add('text-primary-color');
            chatErrorEl.classList.remove('text-text-secondary');
        };

        const disableChat = (reason) => {
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
            chatErrorEl.textContent = reason || "Cannot join chat.";
            chatErrorEl.classList.remove('text-primary-color');
            chatErrorEl.classList.add('text-red-500');
        };

        const updateBannedListUI = () => {
            const listEl = document.getElementById('banned-users-list');
            if (bannedUids.length === 0) {
                listEl.innerHTML = 'No users are currently banned.';
            } else {
                listEl.innerHTML = `<p class="font-semibold">Banned UIDs (${bannedUids.length}):</p><ul>` + 
                                   bannedUids.map(uid => `<li class="font-mono text-xs break-all">${uid}</li>`).join('') +
                                   '</ul>';
            }
        };

        const banUser = async (uidToBan) => {
            if (!isModerator) return showMessageModal("Permission Denied", "You must be a moderator to perform this action.", 'alert');
            uidToBan = uidToBan.trim();
            if (!uidToBan) return showMessageModal("Error", "Please enter a UID to ban.", 'alert');
            
            const confirmed = await showMessageModal("Confirmation", `Are you sure you want to ban user ID: ${uidToBan}?`, 'confirm');
            if (!confirmed) return;

            try {
                const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
                await updateDoc(banDocRef, { uids: arrayUnion(uidToBan) });
                showMessageModal("Success", `${uidToBan} has been successfully banned.`, 'alert');
            } catch (error) {
                console.error("Ban error:", error);
                showMessageModal("Error", `Ban failed: ${error.message}`, 'alert');
            }
        };

        const unbanUser = async (uidToUnban) => {
            if (!isModerator) return showMessageModal("Permission Denied", "You must be a moderator to perform this action.", 'alert');
            uidToUnban = uidToUnban.trim();
            if (!uidToUnban) return showMessageModal("Error", "Please enter a UID to unban.", 'alert');

            const confirmed = await showMessageModal("Confirmation", `Are you sure you want to unban user ID: ${uidToUnban}?`, 'confirm');
            if (!confirmed) return;

            try {
                const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
                await updateDoc(banDocRef, { uids: arrayRemove(uidToUnban) });
                showMessageModal("Success", `User ${uidToUnban} has been unbanned.`, 'alert');
            } catch (error) {
                console.error("Unban error:", error);
                showMessageModal("Error", `Unban failed: ${error.message}`, 'alert');
            }
        };


        // --- PROJECT AND CHAT FUNCTIONALITY ---

        const loadProject = () => {
            const urlInput = document.getElementById('project-url').value;
            const container = document.getElementById('scratch-player-container');
            const placeholder = document.getElementById('player-placeholder');
            const shareBtn = document.getElementById('share-project-btn');

            let projectId = null;

            // Extract ID from Scratch URL
            const scratchMatch = urlInput.match(/scratch\.mit\.edu\/projects\/(\d+)/);
            // Extract ID from TurboWarp URL
            const turbowarpMatch = urlInput.match(/turbowarp\.org\/(\d+)/);

            if (scratchMatch) {
                projectId = scratchMatch[1];
            } else if (turbowarpMatch) {
                projectId = turbowarpMatch[1];
            } else {
                container.innerHTML = `<p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-red-500/70 text-center p-8">Invalid Scratch or TurboWarp project URL format.</p>`;
                shareBtn.disabled = true;
                return;
            }

            const embedUrl = `https://turbowarp.org/${projectId}/embed`;

            container.innerHTML = `<iframe src="${embedUrl}" allowtransparency="true" allowfullscreen="true" scrolling="no" frameborder="0"></iframe>`;
            // Attempt to remove placeholder if it exists
            const currentPlaceholder = document.getElementById('player-placeholder');
            if (currentPlaceholder) currentPlaceholder.remove();
            
            shareBtn.disabled = false;
        };
        
        const shareProject = async () => {
            if (!currentUserNickname) return showMessageModal("Error", "You must set a nickname first.", 'alert');

            const url = document.getElementById('project-url').value;
            const title = document.getElementById('project-title').value.trim();
            const description = document.getElementById('project-description').value.trim();
            
            if (!url || !title) return showMessageModal("Error", "Please enter the URL and Title.", 'alert');

            const newProject = {
                url,
                title,
                description,
                authorUid: currentUserId,
                authorNickname: currentUserNickname,
                createdAt: serverTimestamp(),
                summary: "Summary pending..."
            };

            try {
                await addDoc(collection(db, publicCollectionPath('projects')), newProject);
                showMessageModal("Success", "Your project has been shared on Codes Hub!", 'alert');
                
                // Clear form
                document.getElementById('project-url').value = '';
                document.getElementById('project-title').value = '';
                document.getElementById('project-description').value = '';
                document.getElementById('share-project-btn').disabled = true;
            } catch (error) {
                console.error("Project share error:", error);
                showMessageModal("Error", `An error occurred while sharing the project: ${error.message}`, 'alert');
            }
        };

        const sendMessage = async () => {
            if (!currentUserNickname || isUserBanned(currentUserId)) return;

            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const newMessage = {
                uid: currentUserId,
                nickname: currentUserNickname,
                text: message,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, publicCollectionPath('chat')), newMessage);
                input.value = '';
                // Scroll to bottom
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            } catch (error) {
                console.error("Send message error:", error);
                showMessageModal("Error", `Could not send message: ${error.message}`, 'alert');
            }
        };
        
        // Allow sending message with Enter key
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !sendChatBtn.disabled) {
                sendMessage();
            }
        });


        // --- AI SUMMARIZATION FUNCTION ---

        const summarizeProject = async (projectId, title, description) => {
            const projectDocRef = doc(db, publicCollectionPath('projects'), projectId);
            
            // Give user feedback
            updateDoc(projectDocRef, { summary: "Generating summary..." });

            const systemPrompt = "You are an AI specialized in summarizing Scratch projects in English. Provide a concise, 2-3 sentence, fluent English summary based only on the provided title and description. Do not add any extra information.";
            const userQuery = `Project Title: "${title}"\nProject Description: "${description}"\n\nSummarize this project.`;
            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Construct the request payload
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // API Call (with Exponential Backoff)
            const MAX_API_RETRIES = 5;
            let currentDelay = 1000;

            for (let i = 0; i < MAX_API_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_API_RETRIES - 1) {
                            // Rate limit error, retry
                            console.warn(`API Rate Limit error. Retrying in ${currentDelay / 1000} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2;
                            continue;
                        }
                        throw new Error(`API call failed: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";

                    // Save to Firestore
                    await updateDoc(projectDocRef, { summary: summaryText });
                    return;

                } catch (error) {
                    console.error("Summarization API error:", error);
                    // Save error message to Firestore
                    await updateDoc(projectDocRef, { summary: "Error: Failed to summarize." });
                    return;
                }
            }
            // All attempts failed
            await updateDoc(projectDocRef, { summary: "Error: Failed to summarize due to network issue." });
        };

        // --- FIRESTORE LISTENERS ---

        const setupListeners = () => {
            // 1. Chat Listener
            const chatQuery = query(collection(db, publicCollectionPath('chat')));
            onSnapshot(chatQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                renderChat(messages);
            });
            
            // 2. Projects Feed Listener
            const projectsQuery = query(collection(db, publicCollectionPath('projects')));
            onSnapshot(projectsQuery, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                
                // Show most recently shared first
                projects.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderProjects(projects);
            });

            // 3. Banned User Listener (For Moderator Panel)
            const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
            onSnapshot(banDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    bannedUids = docSnap.data().uids || [];
                    updateBannedListUI();
                    // If user gets banned, disable chat immediately
                    if (isUserBanned(currentUserId)) {
                        disableChat("You are banned.");
                    } else if (currentUserNickname) {
                        // If unbanned, re-enable chat
                        enableChat();
                    }
                }
            });
        };

        // --- RENDER FUNCTIONS ---

        const renderChat = (messages) => {
            chatMessagesEl.innerHTML = '';
            messages.forEach(msg => {
                const isMyMessage = msg.uid === currentUserId;
                const isModMessage = MODERATOR_NAMES.includes(msg.nickname);
                const isBanned = isUserBanned(msg.uid);

                const baseClasses = "p-2 rounded-xl max-w-[80%]";
                const alignmentClasses = isMyMessage ? "ml-auto bg-primary-color text-white" : "mr-auto bg-bg-default border border-border-color";
                const nicknameClasses = isModMessage ? "font-bold text-red-500" : "font-semibold text-primary-color";
                
                let timestampText = '';
                if (msg.timestamp) {
                    const date = msg.timestamp.toDate();
                    timestampText = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                }

                chatMessagesEl.innerHTML += `
                    <div class="flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}">
                        <div class="${baseClasses} ${alignmentClasses} shadow-sm relative">
                            <span class="${nicknameClasses} text-xs block mb-0.5 ${isMyMessage ? 'text-white/80' : ''}">
                                ${msg.nickname} ${isBanned ? '(Banned)' : ''}
                            </span>
                            <p class="text-sm break-words">${msg.text}</p>
                            <span class="text-xs mt-1 block ${isMyMessage ? 'text-white/60' : 'text-text-secondary'}">${timestampText}</span>
                            
                            ${isModerator && !isMyMessage ? `<button onclick="banUser('${msg.uid}')" class="absolute -right-16 top-1/2 -translate-y-1/2 text-xs bg-red-100 text-red-600 p-1 rounded-full opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap">(Ban User)</button>` : ''}
                        </div>
                    </div>
                `;
            });
            // Scroll to bottom on new message
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        };

        const renderProjects = (projects) => {
            projectsFeed.innerHTML = '';
            if (projects.length === 0) {
                projectsFeed.innerHTML = `<p class="text-text-secondary/80 italic text-center p-4">No projects shared yet. Be the first!</p>`;
                return;
            }

            projects.forEach(project => {
                const isMyProject = project.authorUid === currentUserId;
                
                // Escape quotes for onclick function
                const safeTitle = project.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeDescription = project.description.replace(/'/g, "\\'").replace(/"/g, '\\"');

                projectsFeed.innerHTML += `
                    <div class="p-4 card rounded-xl shadow-sm hover:shadow-md transition duration-200 border-l-4 ${isMyProject ? 'border-secondary-color' : 'border-primary-color'}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-base break-words">${project.title}</h4>
                            <span class="text-xs text-text-secondary ml-3 whitespace-nowrap">
                                ${project.createdAt ? project.createdAt.toDate().toLocaleDateString('en-US') : ''}
                            </span>
                        </div>
                        <p class="text-sm text-text-secondary mb-3">Shared by ${project.authorNickname}.</p>
                        
                        <div class="bg-bg-default p-3 rounded-lg border border-border-color/50 mb-3">
                             <p class="text-xs font-medium text-text-secondary mb-1 flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-1 text-secondary-color"></i> AI Summary:
                             </p>
                             <p class="text-sm italic text-text-default">${project.summary}</p>
                        </div>

                        <div class="flex space-x-2 mt-3">
                            <a href="${project.url}" target="_blank" class="text-xs font-semibold text-white bg-primary-color py-1.5 px-3 rounded-full hover:bg-primary-color/80 flex items-center">
                                <i data-lucide="external-link" class="w-4 h-4 mr-1"></i> Go to Project
                            </a>
                            <button onclick="summarizeProject('${project.id}', '${safeTitle}', '${safeDescription}')" 
                                    class="text-xs font-semibold text-white bg-secondary-color py-1.5 px-3 rounded-full hover:bg-secondary-color/80 flex items-center">
                                <i data-lucide="wand-2" class="w-4 h-4 mr-1"></i> Generate AI Summary
                            </button>
                        </div>
                    </div>
                `;
            });
            // Re-render Lucide icons
            lucide.createIcons();
        };

        // --- STARTUP ---
        // Initialize Firebase on window load.
        window.onload = () => {
             // Load Lucide icons
            lucide.createIcons();
            initFirebase();
        };

    </script>
</body>
</html>
