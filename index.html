<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated name: Codes Hub --><title>Codes Hub | Proje Paylaşım Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons (still included for other icons like upload/message) --><script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        /* Color Variables - Light Theme (Default) */
        :root {
            --primary-color: #3b82f6; /* Blue */
            --secondary-color: #f97316; /* Orange */
            --text-default: #1f2937;
            --text-secondary: #4b5563;
            --bg-default: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Color Variables - Dark Theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #38bdf8; /* Light Blue */
                --secondary-color: #f97316; /* Orange */
                --text-default: #f3f4f6;
                --text-secondary: #9ca3af;
                --bg-default: #1f2937;
                --card-bg: #374151;
                --border-color: #4b5563;
                --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-default);
            color: var(--text-default);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-glow);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-field {
            background-color: var(--bg-default);
            border: 1px solid var(--border-color);
            color: var(--text-default);
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            outline: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 80%, black);
            transform: scale(1.02);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 80%, black);
            transform: scale(1.02);
        }

        /* Scratch Player styles */
        #scratch-player-container {
            width: 100%;
            padding-top: 75%; /* 4:3 aspect ratio (480/640 = 0.75) */
            position: relative;
            background-color: var(--bg-default);
        }

        #scratch-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 50;
        }

        .modal-content {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-glow);
            z-index: 51;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Container --><div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header and Status Bar --><header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-border-color">
            <div class="flex items-center space-x-3">
                <!-- LOGO UPDATE: Referencing logo.svg with a styled fallback if the file is not found --><img id="app-logo" src="logo.svg" alt="Codes Hub Logo" 
                     class="w-10 h-10 object-contain" 
                     onerror="this.onerror=null; this.alt='CH'; 
                              this.outerHTML='<span class=\'text-2xl font-extrabold text-primary-color w-10 h-10 flex items-center justify-center rounded-full bg-primary-color/10\'>CH</span>';">
                <!-- Removed: <h1 class="text-2xl font-bold text-text-default">Codes Hub</h1> --></div>
            <div class="mt-4 sm:mt-0 text-right text-sm font-medium text-text-secondary flex items-center space-x-3">
                <span id="auth-status" class="text-xs text-secondary-color font-bold">Yükleniyor...</span>
                <span id="user-info" class="p-1 rounded-md bg-primary-color/10 text-primary-color text-xs">
                    Kullanıcı ID: Yükleniyor...
                </span>
            </div>
        </header>

        <!-- Main Content Grid --><main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Project Upload and Preview --><div class="lg:col-span-2 space-y-8">
                <!-- Project Upload Form --><div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="upload" class="w-6 h-6 mr-3"></i>Yeni Proje Paylaş
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Scratch / TurboWarp URL'si:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="project-url" placeholder="Örn: https://scratch.mit.edu/projects/123456789/"
                                       class="input-field w-full p-2.5 rounded-xl text-sm">
                                <button id="load-project-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="loadProject()">
                                    Projeyi Yükle
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Proje Başlığı:</label>
                            <input type="text" id="project-title" placeholder="Harika Platform Oyunum"
                                   class="input-field w-full p-2.5 rounded-xl text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Açıklama:</label>
                            <textarea id="project-description" rows="3" placeholder="Bu oyunda uzaylılardan kaçıyorsunuz. Hareket etmek için WASD kullanın."
                                      class="input-field w-full p-2.5 rounded-xl text-sm resize-none"></textarea>
                        </div>
                        <button id="share-project-btn" class="btn-secondary text-white font-bold py-3 w-full rounded-xl mt-4" onclick="shareProject()" disabled>
                            Codes Hub'da Paylaş
                        </button>
                    </div>
                </div>

                <!-- Project Preview --><div class="card p-4 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="monitor-play" class="w-6 h-6 mr-3"></i>Proje Önizlemesi
                    </h2>
                    <div id="scratch-player-container" class="bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden shadow-inner">
                        <p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-text-secondary/70 text-center p-8">
                            Yukarıya bir Scratch/TurboWarp URL'si girin ve önizlemeyi görmek için 'Projeyi Yükle'ye tıklayın.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Chat and Projects Feed --><div class="lg:col-span-1 space-y-8">

                <!-- Community Chat --><div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-secondary-color mb-4 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-3"></i>Topluluk Sohbeti
                    </h2>
                    <div id="chat-messages" class="h-64 overflow-y-auto space-y-3 p-3 rounded-xl bg-bg-default border border-border-color mb-4 text-sm">
                        <!-- Messages will be loaded here --><p class="text-text-secondary/80 italic text-center">Mesajlar yükleniyor...</p>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Bir mesaj yazın..."
                               class="input-field w-full p-2.5 rounded-xl text-sm" disabled>
                        <button id="send-chat-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="sendMessage()" disabled>
                            Gönder
                        </button>
                    </div>
                    <!-- Updated text: Kullanıcı Adı --><p id="chat-error" class="text-xs mt-2 text-text-secondary">Sohbet etmek için bir kullanıcı adı belirlemelisiniz.</p>
                </div>

                <!-- Shared Projects Feed --><div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="layers-3" class="w-6 h-6 mr-3"></i>Paylaşılan Projeler
                    </h2>
                    <div id="projects-feed" class="space-y-4 h-[300px] overflow-y-auto">
                        <p class="text-text-secondary/80 italic text-center">Projeler yükleniyor...</p>
                    </div>
                </div>

                <!-- Moderator Panel --><div id="moderation-panel" class="card p-6 rounded-2xl bg-red-500/10 border-red-500/30 hidden">
                    <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-2"></i>Moderatör Kontrol Paneli
                    </h2>
                    <p class="text-sm text-text-secondary mb-3">Yasaklamak veya yasağı kaldırmak için kullanıcının UID'sini girin.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="ban-uid-input" placeholder="Kullanıcı UID" class="input-field w-full p-2 rounded-xl text-sm bg-red-500/5">
                        <button id="ban-user-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-red-700" onclick="banUser(document.getElementById('ban-uid-input').value)">
                            Yasakla
                        </button>
                        <button id="unban-user-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-green-700" onclick="unbanUser(document.getElementById('ban-uid-input').value)">
                            Yasağı Kaldır
                        </button>
                    </div>
                    <div id="banned-users-list" class="mt-4 text-xs text-text-secondary">
                        <!-- Banned UIDs will be loaded here -->Yasaklı kullanıcı listesi yükleniyor...
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Modal Containers --><!-- 1. Username Modal (Sign-in/Registration) --><div id="nickname-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-md p-6 rounded-2xl text-center">
            <!-- Updated text: Kullanıcı Adı --><h3 class="text-2xl font-bold text-primary-color mb-4">Kullanıcı Adınızı Belirleyin</h3>
            <p class="text-sm text-text-secondary mb-6">
                Codes Hub'a katılmak ve toplulukla sohbet etmek için bir kullanıcı adı gereklidir.
            </p>
            <!-- Updated placeholder: Kullanıcı Adı --><input type="text" id="nickname-input" placeholder="Kullanıcı Adınız" class="input-field w-full p-3 rounded-xl mb-4 text-center text-base">
            <button id="save-nickname-btn" class="btn-primary text-white font-bold py-3 w-full rounded-xl" onclick="saveNickname()">
                Kaydet ve Katıl
            </button>
            <p class="text-xs text-text-secondary mt-3">
                Not: Moderatör ayrıcalıklarını kullanmak için kimlik doğrulaması da buradan yapılır.
            </p>
        </div>
    </div>

    <!-- 2. Generic Message Modal (In place of Alert/Confirm) --><div id="message-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 id="msg-title" class="text-xl font-bold text-text-default mb-3">Başlık</h3>
            <p id="msg-body" class="text-sm text-text-secondary mb-6"></p>
            <div id="msg-actions" class="flex justify-center space-x-3">
                <button id="msg-confirm" class="btn-secondary text-white font-semibold py-2 px-4 rounded-xl" onclick="closeMessageModal(true)">
                    Onayla
                </button>
                <button id="msg-cancel" class="bg-gray-300 text-text-default font-semibold py-2 px-4 rounded-xl hover:bg-gray-400" onclick="closeMessageModal(false)">
                    İptal
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports and JS Logic --><script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel, arrayUnion, arrayRemove, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables
        let app, auth, db;
        let currentUserId = null;
        let currentUserNickname = null;
        let isModerator = false;
        let bannedUids = [];

        // Example Nicknames (for Placeholder)
        const EXAMPLE_NICKNAMES = ["KodSihirbazı", "PikselPilot", "ScratchKral", "BlokUstası", "KodcuKedi"];

        // Moderator names (used for permission checks)
        // Note: The user's requested nickname "EmirSeyfOS" is included here for moderator access.
        const MODERATOR_NAMES = ["EmirSeyfOS", "ScratchyXPlus", "ScratchMaster"];

        // UI Elements
        const authStatusEl = document.getElementById('auth-status');
        const userInfoEl = document.getElementById('user-info');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatErrorEl = document.getElementById('chat-error');
        const moderationPanel = document.getElementById('moderation-panel');
        const projectsFeed = document.getElementById('projects-feed');
        const chatMessagesEl = document.getElementById('chat-messages');

        // --- GLOBAL CONFIGURATION ACQUISITION ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'codes-hub-default';

        // Helper for public collection path
        const publicCollectionPath = (collectionName) => `/artifacts/${APP_ID}/public/data/${collectionName}`;

        // --- MODAL FUNCTIONS (In place of Alert/Confirm) ---

        let modalResolve;
        function showMessageModal(title, body, type = 'alert') { // type: 'alert' | 'confirm'
            document.getElementById('msg-title').textContent = title;
            document.getElementById('msg-body').textContent = body;
            
            const confirmBtn = document.getElementById('msg-confirm');
            const cancelBtn = document.getElementById('msg-cancel');

            if (type === 'confirm') {
                confirmBtn.textContent = 'Onayla';
                cancelBtn.classList.remove('hidden');
                return new Promise(resolve => {
                    modalResolve = resolve;
                    document.getElementById('message-modal').classList.remove('hidden');
                    document.getElementById('message-modal').classList.add('flex');
                });
            } else {
                confirmBtn.textContent = 'Kapat';
                cancelBtn.classList.add('hidden');
                document.getElementById('message-modal').classList.remove('hidden');
                document.getElementById('message-modal').classList.add('flex');
                // For simple alerts, no need to wait for anything.
            }
        }

        function closeMessageModal(result) {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        const initFirebase = async () => {
            setLogLevel('Debug');
            
            let firebaseConfig = {};
            
            // --- CRITICAL CONFIG CHECK AND FALLBACK ---
            if (typeof __firebase_config !== 'undefined' && __firebase_config.length > 0) {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    console.error("Error parsing __firebase_config:", e);
                    authStatusEl.textContent = "Hata: Geçersiz Firebase Yapılandırma Formatı.";
                    return;
                }
            } else {
                // FALLBACK: Use a dummy config to prevent the FATAL error and allow the app to run.
                console.warn("WARNING: __firebase_config is missing. Using dummy config for initialization.");
                firebaseConfig = {
                    apiKey: "dummy-key",
                    authDomain: "dummy-domain",
                    projectId: "dummy-project",
                    storageBucket: "dummy-bucket",
                    messagingSenderId: "dummy-sender",
                    appId: "dummy-app-id"
                };
                authStatusEl.textContent = "UYARI: Firebase Yapılandırması Yok. İşlevsellik Devre Dışı.";
            }

            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = "Firebase'e bağlanılıyor...";

                // Set up the listener for auth state changes (MAIN ENTRY POINT OF THE APPLICATION)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userInfoEl.textContent = `Kullanıcı ID: ${currentUserId}`;
                        console.log(`Authentication successful. User UID: ${currentUserId}`);
                        
                        // Load user data and moderator status
                        await loadUserInfo(); 
                        
                        // Check for ban status
                        if (!isUserBanned(currentUserId)) {
                            enableChat();
                        } else {
                            disableChat("Yasaklandınız.");
                        }

                        // Show/hide moderator panel
                        if (isModerator) {
                            moderationPanel.classList.remove('hidden');
                        } else {
                            moderationPanel.classList.add('hidden');
                        }
                        
                        // Start real-time listeners for chat and projects
                        setupListeners();

                    } else {
                        // User logged out or failed sign-in
                        console.log("Auth state changed: User is null (signed out or failed).");
                        currentUserId = null;
                        currentUserNickname = null;
                        isModerator = false;
                        userInfoEl.textContent = "Misafir";
                        authStatusEl.textContent = "Çıkış Yapıldı";
                        disableChat("Oturum Açılmadı");
                    }
                });
                
                // Initiate sign-in process
                if (initialAuthToken) {
                    console.log("Attempting sign-in with Custom Token.");
                    signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom Token sign-in error. Attempting Anonymous sign-in.", e);
                        signInAnonymously(auth);
                    });
                } else {
                    console.log("Attempting Anonymous sign-in.");
                    signInAnonymously(auth);
                }


            } catch (error) {
                console.error("Firebase Initialization or Sign-in Error:", error);
                authStatusEl.textContent = "Hata: Giriş Başarısız. Konsolu Kontrol Edin.";
                showMessageModal("Hata", `Başlatma veya Giriş başarısız: ${error.message}`, 'alert');
            }
        };

        // --- USER INFO AND MODERATION ---

        const loadUserInfo = async () => {
            if (!currentUserId) return;

            // 1. Load Nickname
            try {
                const nicknameDocRef = doc(db, publicCollectionPath('usernames'), currentUserId);
                const nicknameDoc = await getDoc(nicknameDocRef);

                if (nicknameDoc.exists()) { 
                    currentUserNickname = nicknameDoc.data().nickname;
                    // Check moderator status
                    isModerator = MODERATOR_NAMES.includes(currentUserNickname);
                    authStatusEl.textContent = isModerator ? `Moderatör: ${currentUserNickname}` : `Hoş Geldiniz, ${currentUserNickname}`;
                    
                    // Ensure modal is hidden when nickname is loaded
                    document.getElementById('nickname-modal').classList.add('hidden');
                    document.getElementById('nickname-modal').classList.remove('flex');
                } else {
                    // Show modal if no nickname exists
                    showNicknameModal();
                }
            } catch (error) {
                console.error("Error during loadUserInfo:", error);
                authStatusEl.textContent = "Hata: Kullanıcı bilgileri yüklenemedi.";
            }

            // 2. Load Banned User List (initial check, listener handles updates)
            const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
            try {
                const banDoc = await getDoc(banDocRef);
                
                if (banDoc.exists()) {
                    bannedUids = banDoc.data().uids || [];
                } else {
                    // Create the document if it doesn't exist
                    await setDoc(banDocRef, { uids: [] });
                }
                updateBannedListUI();
            } catch (error) {
                console.error("Error loading Banned UIDs:", error);
                // Continue with an empty list on error
                bannedUids = []; 
            }
        };

        const isUserBanned = (uid) => bannedUids.includes(uid);

        const showNicknameModal = () => {
            const randomPlaceholder = EXAMPLE_NICKNAMES[Math.floor(Math.random() * EXAMPLE_NICKNAMES.length)];
            document.getElementById('nickname-input').placeholder = randomPlaceholder;
            document.getElementById('nickname-modal').classList.remove('hidden');
            document.getElementById('nickname-modal').classList.add('flex');
        };

        const saveNickname = async () => {
            const nicknameInput = document.getElementById('nickname-input');
            let nickname = nicknameInput.value.trim();

            if (!nickname) {
                 // Use placeholder if nothing is entered
                 nickname = nicknameInput.placeholder;
            }

            if (nickname.length < 3 || nickname.length > 20) {
                // Updated text: Kullanıcı adı
                showMessageModal("Hata", "Kullanıcı adı 3 ile 20 karakter arasında olmalıdır.", 'alert');
                return;
            }

            try {
                const nicknameDocRef = doc(db, publicCollectionPath('usernames'), currentUserId);
                await setDoc(nicknameDocRef, { nickname: nickname, uid: currentUserId, createdAt: serverTimestamp() });
                
                currentUserNickname = nickname;
                isModerator = MODERATOR_NAMES.includes(nickname);

                // Close Modal
                document.getElementById('nickname-modal').classList.add('hidden');
                document.getElementById('nickname-modal').classList.remove('flex');
                
                if (!isUserBanned(currentUserId)) {
                    enableChat();
                }

                authStatusEl.textContent = isModerator ? `Moderatör: ${currentUserNickname}` : `Hoş Geldiniz, ${currentUserNickname}`;

            } catch (error) {
                console.error("Error saving nickname:", error);
                // Updated text: Kullanıcı adı
                showMessageModal("Hata", "Kullanıcı adı kaydedilemedi. Lütfen tekrar deneyin.", 'alert');
            }
        };
        
        const enableChat = () => {
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            // Updated text: Kullanıcı Adı
            chatErrorEl.textContent = `Sohbet'e Kullanıcı Adı: ${currentUserNickname} olarak katıldınız.`;
            chatErrorEl.classList.add('text-primary-color');
            chatErrorEl.classList.remove('text-text-secondary');
        };

        const disableChat = (reason) => {
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
            chatErrorEl.textContent = reason || "Sohbet'e katılamazsınız.";
            chatErrorEl.classList.remove('text-primary-color');
            chatErrorEl.classList.add('text-red-500');
        };

        const updateBannedListUI = () => {
            const listEl = document.getElementById('banned-users-list');
            if (bannedUids.length === 0) {
                listEl.innerHTML = 'Şu anda yasaklı kullanıcı yok.';
            } else {
                listEl.innerHTML = `<p class="font-semibold">Yasaklı UID'ler (${bannedUids.length}):</p><ul>` + 
                                   bannedUids.map(uid => `<li class="font-mono text-xs break-all">${uid}</li>`).join('') +
                                   '</ul>';
            }
        };

        const banUser = async (uidToBan) => {
            if (!isModerator) return showMessageModal("İçin Reddedildi", "Bu eylemi gerçekleştirmek için moderatör olmalısınız.", 'alert');
            uidToBan = uidToBan.trim();
            if (!uidToBan) return showMessageModal("Hata", "Lütfen yasaklanacak bir UID girin.", 'alert');
            
            const confirmed = await showMessageModal("Onay", `Kullanıcı ID ${uidToBan}'yi yasaklamak istediğinizden emin misiniz?`, 'confirm');
            if (!confirmed) return;

            try {
                const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
                await updateDoc(banDocRef, { uids: arrayUnion(uidToBan) });
                showMessageModal("Başarılı", `${uidToBan} başarıyla yasaklandı.`, 'alert');
            } catch (error) {
                console.error("Ban error:", error);
                showMessageModal("Hata", `Yasaklama başarısız oldu: ${error.message}`, 'alert');
            }
        };

        const unbanUser = async (uidToUnban) => {
            if (!isModerator) return showMessageModal("İzin Reddedildi", "Bu eylemi gerçekleştirmek için moderatör olmalısınız.", 'alert');
            uidToUnban = uidToUnban.trim();
            if (!uidToUnban) return showMessageModal("Hata", "Lütfen yasağı kaldırılacak bir UID girin.", 'alert');

            const confirmed = await showMessageModal("Onay", `Kullanıcının ${uidToUnban} yasağını kaldırmak istediğinizden emin misiniz?`, 'confirm');
            if (!confirmed) return;

            try {
                const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
                await updateDoc(banDocRef, { uids: arrayRemove(uidToUnban) });
                showMessageModal("Başarılı", `Kullanıcının ${uidToUnban} yasağı kaldırıldı.`, 'alert');
            } catch (error) {
                console.error("Unban error:", error);
                showMessageModal("Hata", `Yasağı kaldırma başarısız oldu: ${error.message}`, 'alert');
            }
        };


        // --- PROJECT AND CHAT FUNCTIONALITY ---

        const loadProject = () => {
            const urlInput = document.getElementById('project-url').value;
            const container = document.getElementById('scratch-player-container');
            const shareBtn = document.getElementById('share-project-btn');

            let projectId = null;

            // Extract ID from Scratch URL
            const scratchMatch = urlInput.match(/scratch\.mit\.edu\/projects\/(\d+)/);
            // Extract ID from TurboWarp URL
            const turbowarpMatch = urlInput.match(/turbowarp\.org\/(\d+)/);

            if (scratchMatch) {
                projectId = scratchMatch[1];
            } else if (turbowarpMatch) {
                projectId = turbowarpMatch[1];
            } else {
                container.innerHTML = `<p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-red-500/70 text-center p-8">Geçersiz Scratch veya TurboWarp proje URL'si formatı.</p>`;
                shareBtn.disabled = true;
                return;
            }

            const embedUrl = `https://turbowarp.org/${projectId}/embed`;

            container.innerHTML = `<iframe src="${embedUrl}" allowtransparency="true" allowfullscreen="true" scrolling="no" frameborder="0"></iframe>`;
            // Try to remove existing placeholder
            const currentPlaceholder = document.getElementById('player-placeholder');
            if (currentPlaceholder) currentPlaceholder.remove();
            
            shareBtn.disabled = false;
        };
        
        const shareProject = async () => {
            if (!currentUserNickname) return showMessageModal("Hata", "Önce bir kullanıcı adı belirlemelisiniz.", 'alert');
            if (isUserBanned(currentUserId)) return showMessageModal("Yasaklı", "Yasaklıyken proje paylaşamazsınız.", 'alert');


            const url = document.getElementById('project-url').value;
            const title = document.getElementById('project-title').value.trim();
            const description = document.getElementById('project-description').value.trim();
            
            if (!url || !title) return showMessageModal("Hata", "Lütfen bir URL ve Başlık girin.", 'alert');

            const newProject = {
                url,
                title,
                description,
                authorUid: currentUserId,
                authorNickname: currentUserNickname,
                createdAt: serverTimestamp(),
                summary: "Özet oluşturuluyor..." // Default text while AI is working
            };

            try {
                await addDoc(collection(db, publicCollectionPath('projects')), newProject);
                showMessageModal("Başarılı", "Projeniz Codes Hub'da başarıyla paylaşıldı!", 'alert');
                
                // Clear the form
                document.getElementById('project-url').value = '';
                document.getElementById('project-title').value = '';
                document.getElementById('project-description').value = '';
                document.getElementById('share-project-btn').disabled = true;
            } catch (error) {
                console.error("Project sharing error:", error);
                showMessageModal("Hata", `Projeyi paylaşırken bir hata oluştu: ${error.message}`, 'alert');
            }
        };

        const sendMessage = async () => {
            if (!currentUserNickname || isUserBanned(currentUserId)) return;

            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const newMessage = {
                uid: currentUserId,
                nickname: currentUserNickname,
                text: message,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, publicCollectionPath('chat')), newMessage);
                input.value = '';
                // Scroll to the bottom
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            } catch (error) {
                console.error("Message sending error:", error);
                showMessageModal("Hata", `Mesaj gönderilemedi: ${error.message}`, 'alert');
            }
        };
        
        // Enable sending messages with the Enter key
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !sendChatBtn.disabled) {
                sendMessage();
            }
        });


        // --- AI SUMMARIZATION FUNCTION ---

        const summarizeProject = async (projectId, title, description) => {
            const projectDocRef = doc(db, publicCollectionPath('projects'), projectId);
            
            // Give feedback to the user
            updateDoc(projectDocRef, { summary: "Özet oluşturuluyor..." });

            // IMPORTANT: The system prompt guides the model to output the summary in Turkish.
            const systemPrompt = "Scratch projelerini akıcı Türkçe ile özetleme konusunda uzmanlaşmış bir YZ'sın. Yalnızca sağlanan başlık ve açıklamaya dayanarak kısa, 2-3 cümlelik bir özet sun. Ek bilgi ekleme.";
            const userQuery = `Proje Başlığı: "${title}"\nProje Açıklaması: "${description}"\n\nBu projeyi özetle.`;
            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // Construct the request payload
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // API Call with Exponential Backoff
            const MAX_API_RETRIES = 5;
            let currentDelay = 1000;

            for (let i = 0; i < MAX_API_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_API_RETRIES - 1) {
                            // Rate limit error, retry
                            console.warn(`API Rate Limit error. Retrying in ${currentDelay / 1000} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2;
                            continue;
                        }
                        throw new Error(`API call failed: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Özet oluşturulamadı.";

                    // Save to Firestore
                    await updateDoc(projectDocRef, { summary: summaryText });
                    return;

                } catch (error) {
                    console.error("Summarization API error:", error);
                    // Save error message to Firestore
                    await updateDoc(projectDocRef, { summary: "Hata: Özetleme başarısız oldu." });
                    return;
                }
            }
            // All attempts failed
            await updateDoc(projectDocRef, { summary: "Hata: Ağ sorunu nedeniyle özetleme başarısız oldu." });
        };

        // --- FIRESTORE LISTENERS ---

        const setupListeners = () => {
            // Listeners should only be set up after authentication is successful.
            if (!db || !currentUserId) return;

            // 1. Chat Listener
            const chatQuery = query(collection(db, publicCollectionPath('chat')));
            // Set up new listener
            onSnapshot(chatQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                renderChat(messages);
            });
            
            // 2. Projects Feed Listener
            const projectsQuery = query(collection(db, publicCollectionPath('projects')));
            onSnapshot(projectsQuery, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                
                // Show most recently shared first
                projects.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderProjects(projects);
            });

            // 3. Banned User Listener (for Moderator Panel)
            const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
            onSnapshot(banDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    bannedUids = docSnap.data().uids || [];
                    updateBannedListUI();
                    // Disable chat immediately if user is banned
                    if (isUserBanned(currentUserId)) {
                        disableChat("Yasaklandınız.");
                    } else if (currentUserNickname) {
                        // Re-enable chat if ban is lifted
                        enableChat();
                    }
                } else {
                    // Initialize banned_users array if document doesn't exist
                    setDoc(banDocRef, { uids: [] }).catch(e => console.error("Error creating moderation doc:", e));
                }
            });
        };

        // --- RENDER FUNCTIONS ---

        const renderChat = (messages) => {
            chatMessagesEl.innerHTML = '';
            messages.forEach(msg => {
                const isMyMessage = msg.uid === currentUserId;
                const isModMessage = MODERATOR_NAMES.includes(msg.nickname);
                const isBanned = isUserBanned(msg.uid);

                const baseClasses = "p-2 rounded-xl max-w-[80%]";
                const alignmentClasses = isMyMessage ? "ml-auto bg-primary-color text-white" : "mr-auto bg-bg-default border border-border-color";
                const nicknameClasses = isModMessage ? "font-bold text-red-500" : "font-semibold text-primary-color";
                
                let timestampText = '';
                if (msg.timestamp) {
                    const date = msg.timestamp.toDate();
                    timestampText = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                }

                chatMessagesEl.innerHTML += `
                    <div class="flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}">
                        <div class="${baseClasses} ${alignmentClasses} shadow-sm relative">
                            <span class="${nicknameClasses} text-xs block mb-0.5 ${isMyMessage ? 'text-white/80' : ''}">
                                ${msg.nickname} ${isBanned ? '(Yasaklı)' : ''}
                            </span>
                            <p class="text-sm break-words">${msg.text}</p>
                            <span class="text-xs mt-1 block ${isMyMessage ? 'text-white/60' : 'text-text-secondary'}">${timestampText}</span>
                            
                            ${isModerator && !isMyMessage ? `<button onclick="banUser('${msg.uid}')" class="absolute -right-16 top-1/2 -translate-y-1/2 text-xs bg-red-100 text-red-600 p-1 rounded-full opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap">(Kullanıcıyı Yasakla)</button>` : ''}
                        </div>
                    </div>
                `;
            });
            // Scroll to the bottom on new message
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        };

        const renderProjects = (projects) => {
            projectsFeed.innerHTML = '';
            if (projects.length === 0) {
                projectsFeed.innerHTML = `<p class="text-text-secondary/80 italic text-center p-4">Henüz proje paylaşılmadı. İlk siz olun!</p>`;
                return;
            }

            projects.forEach(project => {
                const isMyProject = project.authorUid === currentUserId;
                
                // Escape quotes for onclick function
                const safeTitle = project.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeDescription = project.description.replace(/'/g, "\\'").replace(/"/g, '\\"');

                projectsFeed.innerHTML += `
                    <div class="p-4 card rounded-xl shadow-sm hover:shadow-md transition duration-200 border-l-4 ${isMyProject ? 'border-secondary-color' : 'border-primary-color'}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-base break-words">${project.title}</h4>
                            <span class="text-xs text-text-secondary ml-3 whitespace-nowrap">
                                ${project.createdAt ? project.createdAt.toDate().toLocaleDateString('tr-TR') : ''}
                            </span>
                        </div>
                        <p class="text-sm text-text-secondary mb-3">Paylaşan: ${project.authorNickname}.</p>
                        
                        <div class="bg-bg-default p-3 rounded-lg border border-border-color/50 mb-3">
                             <p class="text-xs font-medium text-text-secondary mb-1 flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-1 text-secondary-color"></i> YZ Özeti:
                             </p>
                             <p class="text-sm italic text-text-default">${project.summary}</p>
                        </div>

                        <div class="flex space-x-2 mt-3">
                            <a href="${project.url}" target="_blank" class="text-xs font-semibold text-white bg-primary-color py-1.5 px-3 rounded-full hover:bg-primary-color/80 flex items-center">
                                <i data-lucide="external-link" class="w-4 h-4 mr-1"></i> Projeye Git
                            </a>
                            <button onclick="summarizeProject('${project.id}', '${safeTitle}', '${safeDescription}')" 
                                    class="text-xs font-semibold text-white bg-secondary-color py-1.5 px-3 rounded-full hover:bg-secondary-color/80 flex items-center">
                                <i data-lucide="wand-2" class="w-4 h-4 mr-1"></i> Yapay Zeka Özeti Oluştur
                            </button>
                        </div>
                    </div>
                `;
            });
            // Re-render Lucide icons
            lucide.createIcons();
        };

        // --- GLOBAL ACCESS POINTS (for onclick in HTML) ---
        window.loadProject = loadProject;
        window.shareProject = shareProject;
        window.sendMessage = sendMessage;
        window.saveNickname = saveNickname;
        window.banUser = banUser;
        window.unbanUser = unbanUser;
        window.closeMessageModal = closeMessageModal;
        window.summarizeProject = summarizeProject;


        // --- STARTUP ---
        // Initialize Firebase when the window loads.
        window.onload = () => {
             // Load Lucide icons
            lucide.createIcons();
            initFirebase();
        };

    </script>
</body>
</html>
