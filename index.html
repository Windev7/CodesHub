<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codes Hub | Proje Paylaşım Platformu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        /* Color Variables - Light Theme (Default) */
        :root {
            --primary-color: #3b82f6; /* Blue */
            --secondary-color: #f97316; /* Orange */
            --text-default: #1f2937;
            --text-secondary: #4b5563;
            --bg-default: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Color Variables - Dark Theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #38bdf8; /* Light Blue */
                --secondary-color: #f97316; /* Orange */
                --text-default: #f3f4f6;
                --text-secondary: #9ca3af;
                --bg-default: #1f2937;
                --card-bg: #374151;
                --border-color: #4b5563;
                --shadow-glow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-default);
            color: var(--text-default);
            transition: background-color 0.3s, color 0.3s;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-glow);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .input-field {
            background-color: var(--bg-default);
            border: 1px solid var(--border-color);
            color: var(--text-default);
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            outline: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary:hover {
            background-color: color-mix(in srgb, var(--primary-color) 80%, black);
            transform: scale(1.02);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-color) 80%, black);
            transform: scale(1.02);
        }

        /* Scratch Player styles */
        #scratch-player-container {
            width: 100%;
            padding-top: 75%; /* 4:3 aspect ratio (480/640 = 0.75) */
            position: relative;
            background-color: var(--bg-default);
        }

        #scratch-player-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.75rem;
        }

        /* Modal Styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 50;
        }

        .modal-content {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-glow);
            z-index: 51;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Ana Konteyner -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Başlık ve Durum Çubuğu -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-border-color">
            <div class="flex items-center space-x-3">
                <img src="logo.svg" alt="Codes Hub Logo" class="h-10 w-auto">
            </div>
            <div class="mt-4 sm:mt-0 text-right text-sm font-medium text-text-secondary flex items-center space-x-3">
                <span id="auth-status" class="text-xs text-secondary-color font-bold">Yükleniyor...</span>
                <span id="user-info" class="p-1 rounded-md bg-primary-color/10 text-primary-color text-xs">
                    Kullanıcı ID: Yükleniyor...
                </span>
            </div>
        </header>

        <!-- Ana İçerik Izgarası -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Sol Sütun: Proje Yükleme ve Önizleme -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Proje Yükleme Formu -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="upload" class="w-6 h-6 mr-3"></i>Yeni Proje Paylaş
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Scratch / TurboWarp URL'si:</label>
                            <div class="flex space-x-2">
                                <input type="text" id="project-url" placeholder="Örn: https://scratch.mit.edu/projects/123456789/"
                                       class="input-field w-full p-2.5 rounded-xl text-sm">
                                <button id="load-project-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="loadProject()">
                                    Projeyi Yükle
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Proje Başlığı:</label>
                            <input type="text" id="project-title" placeholder="Harika Platform Oyunum"
                                   class="input-field w-full p-2.5 rounded-xl text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Açıklama:</label>
                            <textarea id="project-description" rows="3" placeholder="Bu oyunda uzaylılardan kaçıyorsunuz. Hareket etmek için WASD kullanın."
                                      class="input-field w-full p-2.5 rounded-xl text-sm resize-none"></textarea>
                        </div>
                        <button id="share-project-btn" class="btn-secondary text-white font-bold py-3 w-full rounded-xl mt-4" onclick="shareProject()" disabled>
                            Codes Hub'da Paylaş
                        </button>
                    </div>
                </div>

                <!-- Proje Önizlemesi -->
                <div class="card p-4 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="monitor-play" class="w-6 h-6 mr-3"></i>Proje Önizlemesi
                    </h2>
                    <div id="scratch-player-container" class="bg-gray-100 dark:bg-gray-800 rounded-xl overflow-hidden shadow-inner">
                        <p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-text-secondary/70 text-center p-8">
                            Önizlemeyi görmek için yukarıya bir Scratch/TurboWarp URL'si girin ve 'Projeyi Yükle' butonuna tıklayın.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Sağ Sütun: Sohbet ve Projeler Akışı -->
            <div class="lg:col-span-1 space-y-8">

                <!-- Topluluk Sohbeti -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-secondary-color mb-4 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-3"></i>Topluluk Sohbeti
                    </h2>
                    <div id="chat-messages" class="h-64 overflow-y-auto space-y-3 p-3 rounded-xl bg-bg-default border border-border-color mb-4 text-sm">
                        <!-- Mesajlar buraya yüklenecek -->
                        <p class="text-text-secondary/80 italic text-center">Mesajlar yükleniyor...</p>
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="chat-input" placeholder="Bir mesaj yazın..."
                               class="input-field w-full p-2.5 rounded-xl text-sm" disabled>
                        <button id="send-chat-btn" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl whitespace-nowrap" onclick="sendMessage()" disabled>
                            Gönder
                        </button>
                    </div>
                    <p id="chat-error" class="text-xs mt-2 text-text-secondary">Sohbet etmek için bir takma ad belirlemelisiniz.</p>
                </div>

                <!-- Paylaşılan Projeler Akışı -->
                <div class="card p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-primary-color mb-4 flex items-center">
                        <i data-lucide="layers-3" class="w-6 h-6 mr-3"></i>Paylaşılan Projeler
                    </h2>
                    <div id="projects-feed" class="space-y-4 h-[300px] overflow-y-auto">
                        <p class="text-text-secondary/80 italic text-center">Projeler yükleniyor...</p>
                    </div>
                </div>

                <!-- Moderatör Paneli -->
                <div id="moderation-panel" class="card p-6 rounded-2xl bg-red-500/10 border-red-500/30 hidden">
                    <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 mr-2"></i>Moderatör Kontrol Paneli
                    </h2>
                    <p class="text-sm text-text-secondary mb-3">Yasaklamak veya yasağı kaldırmak için kullanıcının UID'sini girin.</p>
                    <div class="flex space-x-2">
                        <input type="text" id="ban-uid-input" placeholder="Kullanıcı UID'si" class="input-field w-full p-2 rounded-xl text-sm bg-red-500/5">
                        <button id="ban-user-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-red-700" onclick="banUser(document.getElementById('ban-uid-input').value)">
                            Yasakla
                        </button>
                        <button id="unban-user-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-xl text-sm hover:bg-green-700" onclick="unbanUser(document.getElementById('ban-uid-input').value)">
                            Yasağı Kaldır
                        </button>
                    </div>
                    <div id="banned-users-list" class="mt-4 text-xs text-text-secondary">
                        <!-- Yasaklı UID'ler buraya yüklenecek -->
                        Yasaklı kullanıcı listesi yükleniyor...
                    </div>
                </div>
            </div>
        </main>

    </div>

    <!-- Modal Konteynerları -->

    <!-- 1. Takma Ad Modalı (Giriş/Kayıt) -->
    <div id="nickname-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-md p-6 rounded-2xl text-center">
            <h3 class="text-2xl font-bold text-primary-color mb-4">Takma Adınızı Belirleyin</h3>
            <p class="text-sm text-text-secondary mb-6">
                Codes Hub'a katılmak ve toplulukla sohbet etmek için bir takma ad gereklidir.
            </p>
            <input type="text" id="nickname-input" placeholder="Takma Adınız" class="input-field w-full p-3 rounded-xl mb-4 text-center text-base">
            <button id="save-nickname-btn" class="btn-primary text-white font-bold py-3 w-full rounded-xl" onclick="saveNickname()">
                Kaydet ve Katıl
            </button>
            <p class="text-xs text-text-secondary mt-3">
                Not: Moderatör yetkilerini kullanmak için giriş yaptığınız yer de burasıdır.
            </p>
        </div>
    </div>

    <!-- 2. Genel Mesaj Modalı (Alert/Confirm yerine) -->
    <div id="message-modal" class="fixed inset-0 hidden items-center justify-center p-4 modal-overlay">
        <div class="modal-content w-full max-w-sm p-6 rounded-2xl text-center">
            <h3 id="msg-title" class="text-xl font-bold text-text-default mb-3">Başlık</h3>
            <p id="msg-body" class="text-sm text-text-secondary mb-6"></p>
            <div id="msg-actions" class="flex justify-center space-x-3">
                <button id="msg-confirm" class="btn-secondary text-white font-semibold py-2 px-4 rounded-xl" onclick="closeMessageModal(true)">
                    Onayla
                </button>
                <button id="msg-cancel" class="bg-gray-300 text-text-default font-semibold py-2 px-4 rounded-xl hover:bg-gray-400" onclick="closeMessageModal(false)">
                    İptal Et
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports ve JS Mantığı -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, setLogLevel, arrayUnion, arrayRemove, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase global variables
        let app, auth, db;
        let currentUserId = null;
        let currentUserNickname = null;
        let isModerator = false;
        let bannedUids = [];

        // Örnek Takma Adlar (Placeholder için)
        const EXAMPLE_NICKNAMES = ["KodBüyücüsü", "PikselPilot", "ScratchKralı", "BlokUstası", "KodcuKedi"];

        // Moderatör isimleri (izin kontrolü için kullanılır)
        const MODERATOR_NAMES = ["EmirSeyfOS", "ScratchyXPlus", "ScratchMaster"];

        // UI Elemanları
        const authStatusEl = document.getElementById('auth-status');
        const userInfoEl = document.getElementById('user-info');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatErrorEl = document.getElementById('chat-error');
        const moderationPanel = document.getElementById('moderation-panel');
        const projectsFeed = document.getElementById('projects-feed');
        const chatMessagesEl = document.getElementById('chat-messages');

        // --- GLOBAL YAPILANDIRMA ALIMI ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'codes-hub-default';

        // Genel koleksiyon yolu yardımcısı
        const publicCollectionPath = (collectionName) => `/artifacts/${APP_ID}/public/data/${collectionName}`;

        // --- MODAL FONKSİYONLARI (Alert/Confirm yerine) ---

        let modalResolve;
        function showMessageModal(title, body, type = 'alert') { // type: 'alert' | 'confirm'
            document.getElementById('msg-title').textContent = title;
            document.getElementById('msg-body').textContent = body;
            
            const confirmBtn = document.getElementById('msg-confirm');
            const cancelBtn = document.getElementById('msg-cancel');

            if (type === 'confirm') {
                confirmBtn.textContent = 'Onayla';
                cancelBtn.classList.remove('hidden');
                return new Promise(resolve => {
                    modalResolve = resolve;
                    document.getElementById('message-modal').classList.remove('hidden');
                    document.getElementById('message-modal').classList.add('flex');
                });
            } else {
                confirmBtn.textContent = 'Kapat';
                cancelBtn.classList.add('hidden');
                document.getElementById('message-modal').classList.remove('hidden');
                document.getElementById('message-modal').classList.add('flex');
                // Basit uyarılar için herhangi bir şey beklemeye gerek yok.
            }
        }

        function closeMessageModal(result) {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
            if (modalResolve) {
                modalResolve(result);
                modalResolve = null;
            }
        }


        // --- FIREBASE BAŞLATMA VE DOĞRULAMA ---

        const initFirebase = async () => {
            setLogLevel('Debug');
            
            // Kritik Kontrol: Yapılandırma dizisinin var olduğundan emin olun
            if (typeof __firebase_config === 'undefined' || __firebase_config.length === 0) {
                authStatusEl.textContent = "Hata: Firebase Yapılandırması Eksik.";
                console.error("FATAL: __firebase_config is missing or empty.");
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                authStatusEl.textContent = "Firebase'e Bağlanılıyor...";

                // Durum değişiklikleri için dinleyiciyi AYARLAYIN (UYGULAMANIN ANA GİRİŞ NOKTASI)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userInfoEl.textContent = `Kullanıcı ID: ${currentUserId}`;
                        console.log(`Doğrulama başarılı. Kullanıcı UID: ${currentUserId}`);
                        
                        // Kullanıcı verilerini ve moderatör durumunu yükle
                        await loadUserInfo(); 
                        
                        // Yasaklanma durumunu kontrol et
                        if (!isUserBanned(currentUserId)) {
                            enableChat();
                        } else {
                            disableChat("Yasaklandınız.");
                        }

                        // Moderatör panelini göster/gizle
                        if (isModerator) {
                            moderationPanel.classList.remove('hidden');
                        } else {
                            moderationPanel.classList.add('hidden');
                        }
                        
                        // Sohbet ve projeler için gerçek zamanlı dinleyicileri başlat
                        setupListeners();

                    } else {
                        // Kullanıcı oturumu kapattı veya giriş başarısız oldu
                        console.log("Doğrulama durumu değişti: Kullanıcı null (çıkış yapıldı veya başarısız).");
                        currentUserId = null;
                        currentUserNickname = null;
                        isModerator = false;
                        userInfoEl.textContent = "Misafir";
                        authStatusEl.textContent = "Çıkış Yapıldı";
                        disableChat("Çıkış Yapıldı");
                    }
                });
                
                // Oturum açma işlemini başlatın (sonuç dinleyici tarafından işlenecektir)
                if (initialAuthToken) {
                    console.log("Özel Token ile oturum açma deneniyor.");
                    signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom Token ile oturum açma hatası. Anonim oturum açma deneniyor.", e);
                        signInAnonymously(auth);
                    });
                } else {
                    console.log("Anonim oturum açma deneniyor.");
                    signInAnonymously(auth);
                }


            } catch (error) {
                console.error("Firebase Başlatma veya Oturum Açma Hatası:", error);
                authStatusEl.textContent = "Hata: Giriş Başarısız. Konsolu Kontrol Edin.";
                showMessageModal("Hata", `Başlatma veya Giriş başarısız: ${error.message}`, 'alert');
            }
        };

        // --- KULLANICI BİLGİSİ VE MODERASYON ---

        const loadUserInfo = async () => {
            if (!currentUserId) return;

            // 1. Takma Adı Yükle
            try {
                const nicknameDocRef = doc(db, publicCollectionPath('usernames'), currentUserId);
                const nicknameDoc = await getDoc(nicknameDocRef);

                if (nicknameDoc.exists()) { 
                    currentUserNickname = nicknameDoc.data().nickname;
                    // Moderatör durumunu kontrol et
                    isModerator = MODERATOR_NAMES.includes(currentUserNickname);
                    authStatusEl.textContent = isModerator ? `Moderatör: ${currentUserNickname}` : `Hoş Geldiniz, ${currentUserNickname}`;
                    
                    // Takma ad kaydedildiğinde modalın gizli olduğundan emin olun
                    document.getElementById('nickname-modal').classList.add('hidden');
                    document.getElementById('nickname-modal').classList.remove('flex');
                } else {
                    // Takma ad yoksa modalı göster
                    showNicknameModal();
                }
            } catch (error) {
                console.error("loadUserInfo sırasında hata:", error);
                authStatusEl.textContent = "Hata: Kullanıcı Bilgisi Yüklenemedi.";
            }

            // 2. Yasaklı Kullanıcı Listesini Yükle (başlangıç kontrolü, dinleyici güncellemeleri halleder)
            const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
            try {
                const banDoc = await getDoc(banDocRef);
                
                if (banDoc.exists()) {
                    bannedUids = banDoc.data().uids || [];
                } else {
                    // Belge yoksa oluştur
                    await setDoc(banDocRef, { uids: [] });
                }
                updateBannedListUI();
            } catch (error) {
                console.error("Yasaklı UID'leri yükleme hatası:", error);
                // Hata durumunda boş liste ile devam et
                bannedUids = []; 
            }
        };

        const isUserBanned = (uid) => bannedUids.includes(uid);

        const showNicknameModal = () => {
            const randomPlaceholder = EXAMPLE_NICKNAMES[Math.floor(Math.random() * EXAMPLE_NICKNAMES.length)];
            document.getElementById('nickname-input').placeholder = randomPlaceholder;
            document.getElementById('nickname-modal').classList.remove('hidden');
            document.getElementById('nickname-modal').classList.add('flex');
        };

        const saveNickname = async () => {
            const nicknameInput = document.getElementById('nickname-input');
            const nickname = nicknameInput.value.trim();

            if (nickname.length < 3 || nickname.length > 20) {
                showMessageModal("Hata", "Takma ad 3 ile 20 karakter arasında olmalıdır.", 'alert');
                return;
            }

            // Takma adın zaten moderatör isimlerinden biri olup olmadığını kontrol et
            if (MODERATOR_NAMES.includes(nickname) && currentUserId !== 'YOUR_MODERATOR_UID') { // Bu kontrol, birisinin moderator adını almasını engeller
                 // Moderatör ismini denetlemek için ek bir mekanizma gerekebilir, şimdilik sadece kaydetmeye devam edelim.
            }

            try {
                const nicknameDocRef = doc(db, publicCollectionPath('usernames'), currentUserId);
                await setDoc(nicknameDocRef, { nickname: nickname, uid: currentUserId, createdAt: serverTimestamp() });
                
                currentUserNickname = nickname;
                isModerator = MODERATOR_NAMES.includes(nickname);

                // Modal'ı Kapat
                document.getElementById('nickname-modal').classList.add('hidden');
                document.getElementById('nickname-modal').classList.remove('flex');
                
                if (!isUserBanned(currentUserId)) {
                    enableChat();
                }

                authStatusEl.textContent = isModerator ? `Moderatör: ${currentUserNickname}` : `Hoş Geldiniz, ${currentUserNickname}`;

            } catch (error) {
                console.error("Takma ad kaydetme hatası:", error);
                showMessageModal("Hata", "Takma ad kaydedilemedi. Lütfen tekrar deneyin.", 'alert');
            }
        };
        
        const enableChat = () => {
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            chatErrorEl.textContent = `Sohbete şu isimle katıldınız: ${currentUserNickname}.`;
            chatErrorEl.classList.add('text-primary-color');
            chatErrorEl.classList.remove('text-text-secondary');
        };

        const disableChat = (reason) => {
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
            chatErrorEl.textContent = reason || "Sohbete Katılamazsınız.";
            chatErrorEl.classList.remove('text-primary-color');
            chatErrorEl.classList.add('text-red-500');
        };

        const updateBannedListUI = () => {
            const listEl = document.getElementById('banned-users-list');
            if (bannedUids.length === 0) {
                listEl.innerHTML = 'Şu anda yasaklı kullanıcı yok.';
            } else {
                listEl.innerHTML = `<p class="font-semibold">Yasaklı UID'ler (${bannedUids.length}):</p><ul>` + 
                                   bannedUids.map(uid => `<li class="font-mono text-xs break-all">${uid}</li>`).join('') +
                                   '</ul>';
            }
        };

        const banUser = async (uidToBan) => {
            if (!isModerator) return showMessageModal("İzin Reddedildi", "Bu eylemi gerçekleştirmek için moderatör olmalısınız.", 'alert');
            uidToBan = uidToBan.trim();
            if (!uidToBan) return showMessageModal("Hata", "Lütfen yasaklamak için bir UID girin.", 'alert');
            
            const confirmed = await showMessageModal("Onay", `Kullanıcı ID'si ${uidToBan}'ı yasaklamak istediğinizden emin misiniz?`, 'confirm');
            if (!confirmed) return;

            try {
                const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
                await updateDoc(banDocRef, { uids: arrayUnion(uidToBan) });
                showMessageModal("Başarılı", `${uidToBan} başarıyla yasaklandı.`, 'alert');
            } catch (error) {
                console.error("Yasaklama hatası:", error);
                showMessageModal("Hata", `Yasaklama başarısız oldu: ${error.message}`, 'alert');
            }
        };

        const unbanUser = async (uidToUnban) => {
            if (!isModerator) return showMessageModal("İzin Reddedildi", "Bu eylemi gerçekleştirmek için moderatör olmalısınız.", 'alert');
            uidToUnban = uidToUnban.trim();
            if (!uidToUnban) return showMessageModal("Hata", "Lütfen yasağı kaldırmak için bir UID girin.", 'alert');

            const confirmed = await showMessageModal("Onay", `Kullanıcı ID'si ${uidToUnban}'ın yasağını kaldırmak istediğinizden emin misiniz?`, 'confirm');
            if (!confirmed) return;

            try {
                const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
                await updateDoc(banDocRef, { uids: arrayRemove(uidToUnban) });
                showMessageModal("Başarılı", `Kullanıcı ${uidToUnban} yasağı kaldırıldı.`, 'alert');
            } catch (error) {
                console.error("Yasağı kaldırma hatası:", error);
                showMessageModal("Hata", `Yasağı kaldırma başarısız oldu: ${error.message}`, 'alert');
            }
        };


        // --- PROJE VE SOHBET İŞLEVSELLİĞİ ---

        const loadProject = () => {
            const urlInput = document.getElementById('project-url').value;
            const container = document.getElementById('scratch-player-container');
            const placeholder = document.getElementById('player-placeholder');
            const shareBtn = document.getElementById('share-project-btn');

            let projectId = null;

            // Scratch URL'sinden ID'yi çıkar
            const scratchMatch = urlInput.match(/scratch\.mit\.edu\/projects\/(\d+)/);
            // TurboWarp URL'sinden ID'yi çıkar
            const turbowarpMatch = urlInput.match(/turbowarp\.org\/(\d+)/);

            if (scratchMatch) {
                projectId = scratchMatch[1];
            } else if (turbowarpMatch) {
                projectId = turbowarpMatch[1];
            } else {
                container.innerHTML = `<p id="player-placeholder" class="absolute inset-0 flex items-center justify-center text-red-500/70 text-center p-8">Geçersiz Scratch veya TurboWarp proje URL formatı.</p>`;
                shareBtn.disabled = true;
                return;
            }

            const embedUrl = `https://turbowarp.org/${projectId}/embed`;

            container.innerHTML = `<iframe src="${embedUrl}" allowtransparency="true" allowfullscreen="true" scrolling="no" frameborder="0"></iframe>`;
            // Placeholder varsa kaldırmaya çalış
            const currentPlaceholder = document.getElementById('player-placeholder');
            if (currentPlaceholder) currentPlaceholder.remove();
            
            shareBtn.disabled = false;
        };
        
        const shareProject = async () => {
            if (!currentUserNickname) return showMessageModal("Hata", "Öncelikle bir takma ad belirlemelisiniz.", 'alert');

            const url = document.getElementById('project-url').value;
            const title = document.getElementById('project-title').value.trim();
            const description = document.getElementById('project-description').value.trim();
            
            if (!url || !title) return showMessageModal("Hata", "Lütfen URL ve Başlığı girin.", 'alert');

            const newProject = {
                url,
                title,
                description,
                authorUid: currentUserId,
                authorNickname: currentUserNickname,
                createdAt: serverTimestamp(),
                summary: "Özet beklemede..."
            };

            try {
                await addDoc(collection(db, publicCollectionPath('projects')), newProject);
                showMessageModal("Başarılı", "Projeniz Codes Hub'da paylaşıldı!", 'alert');
                
                // Formu temizle
                document.getElementById('project-url').value = '';
                document.getElementById('project-title').value = '';
                document.getElementById('project-description').value = '';
                document.getElementById('share-project-btn').disabled = true;
            } catch (error) {
                console.error("Proje paylaşım hatası:", error);
                showMessageModal("Hata", `Proje paylaşılırken bir hata oluştu: ${error.message}`, 'alert');
            }
        };

        const sendMessage = async () => {
            if (!currentUserNickname || isUserBanned(currentUserId)) return;

            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message) return;

            const newMessage = {
                uid: currentUserId,
                nickname: currentUserNickname,
                text: message,
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, publicCollectionPath('chat')), newMessage);
                input.value = '';
                // En alta kaydır
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            } catch (error) {
                console.error("Mesaj gönderme hatası:", error);
                showMessageModal("Hata", `Mesaj gönderilemedi: ${error.message}`, 'alert');
            }
        };
        
        // Enter tuşuyla mesaj göndermeyi etkinleştir
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !sendChatBtn.disabled) {
                sendMessage();
            }
        });


        // --- YZ ÖZETLEME FONKSİYONU ---

        const summarizeProject = async (projectId, title, description) => {
            const projectDocRef = doc(db, publicCollectionPath('projects'), projectId);
            
            // Kullanıcıya geri bildirim ver
            updateDoc(projectDocRef, { summary: "Özet oluşturuluyor..." });

            const systemPrompt = "Scratch projelerini İngilizce olarak özetlemede uzmanlaşmış bir YZ'siniz. Yalnızca sağlanan başlık ve açıklamaya dayanarak kısa, 2-3 cümlelik, akıcı bir İngilizce özet sağlayın. Fazladan bilgi eklemeyin.";
            const userQuery = `Project Title: "${title}"\nProject Description: "${description}"\n\nSummarize this project.`;
            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            // İstek yükünü oluştur
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // API Çağrısı (Üstel Geri Çekilme ile)
            const MAX_API_RETRIES = 5;
            let currentDelay = 1000;

            for (let i = 0; i < MAX_API_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < MAX_API_RETRIES - 1) {
                            // Hız sınırı hatası, yeniden dene
                            console.warn(`API Hız Sınırı hatası. ${currentDelay / 1000} saniye içinde yeniden deneniyor...`);
                            await new Promise(resolve => setTimeout(resolve, currentDelay));
                            currentDelay *= 2;
                            continue;
                        }
                        throw new Error(`API çağrısı başarısız oldu: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Özet oluşturulamadı.";

                    // Firestore'a kaydet
                    await updateDoc(projectDocRef, { summary: summaryText });
                    return;

                } catch (error) {
                    console.error("Özetleme API hatası:", error);
                    // Hata mesajını Firestore'a kaydet
                    await updateDoc(projectDocRef, { summary: "Hata: Özetleme başarısız oldu." });
                    return;
                }
            }
            // Tüm denemeler başarısız oldu
            await updateDoc(projectDocRef, { summary: "Hata: Ağ sorunu nedeniyle özetleme başarısız oldu." });
        };

        // --- FIRESTORE DİNLEYİCİLERİ ---

        const setupListeners = () => {
            // Dinleyiciler yalnızca kimlik doğrulama başarılı olduktan sonra kurulmalıdır.
            if (!db || !currentUserId) return;

            // 1. Sohbet Dinleyicisi
            const chatQuery = query(collection(db, publicCollectionPath('chat')));
            // Mevcut dinleyiciyi temizle (varsa) ve yenisini ayarla
            onSnapshot(chatQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                renderChat(messages);
            });
            
            // 2. Projeler Akışı Dinleyicisi
            const projectsQuery = query(collection(db, publicCollectionPath('projects')));
            onSnapshot(projectsQuery, (snapshot) => {
                const projects = [];
                snapshot.forEach(doc => {
                    projects.push({ id: doc.id, ...doc.data() });
                });
                
                // En son paylaşılanları ilk göster
                projects.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                renderProjects(projects);
            });

            // 3. Yasaklı Kullanıcı Dinleyicisi (Moderatör Paneli için)
            const banDocRef = doc(db, publicCollectionPath('moderation'), 'banned_users');
            onSnapshot(banDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    bannedUids = docSnap.data().uids || [];
                    updateBannedListUI();
                    // Kullanıcı yasaklanırsa, sohbeti hemen devre dışı bırak
                    if (isUserBanned(currentUserId)) {
                        disableChat("Yasaklandınız.");
                    } else if (currentUserNickname) {
                        // Yasağı kalkarsa, sohbeti yeniden etkinleştir
                        enableChat();
                    }
                }
            });
        };

        // --- RENDER FONKSİYONLARI ---

        const renderChat = (messages) => {
            chatMessagesEl.innerHTML = '';
            messages.forEach(msg => {
                const isMyMessage = msg.uid === currentUserId;
                const isModMessage = MODERATOR_NAMES.includes(msg.nickname);
                const isBanned = isUserBanned(msg.uid);

                const baseClasses = "p-2 rounded-xl max-w-[80%]";
                const alignmentClasses = isMyMessage ? "ml-auto bg-primary-color text-white" : "mr-auto bg-bg-default border border-border-color";
                const nicknameClasses = isModMessage ? "font-bold text-red-500" : "font-semibold text-primary-color";
                
                let timestampText = '';
                if (msg.timestamp) {
                    const date = msg.timestamp.toDate();
                    timestampText = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                }

                chatMessagesEl.innerHTML += `
                    <div class="flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}">
                        <div class="${baseClasses} ${alignmentClasses} shadow-sm relative">
                            <span class="${nicknameClasses} text-xs block mb-0.5 ${isMyMessage ? 'text-white/80' : ''}">
                                ${msg.nickname} ${isBanned ? '(Yasaklı)' : ''}
                            </span>
                            <p class="text-sm break-words">${msg.text}</p>
                            <span class="text-xs mt-1 block ${isMyMessage ? 'text-white/60' : 'text-text-secondary'}">${timestampText}</span>
                            
                            ${isModerator && !isMyMessage ? `<button onclick="banUser('${msg.uid}')" class="absolute -right-16 top-1/2 -translate-y-1/2 text-xs bg-red-100 text-red-600 p-1 rounded-full opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap">(Kullanıcıyı Yasakla)</button>` : ''}
                        </div>
                    </div>
                `;
            });
            // Yeni mesajda en alta kaydır
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
        };

        const renderProjects = (projects) => {
            projectsFeed.innerHTML = '';
            if (projects.length === 0) {
                projectsFeed.innerHTML = `<p class="text-text-secondary/80 italic text-center p-4">Henüz proje paylaşılmadı. İlk siz olun!</p>`;
                return;
            }

            projects.forEach(project => {
                const isMyProject = project.authorUid === currentUserId;
                
                // Onclick fonksiyonu için tırnak işaretlerini kaçış karakteriyle koru
                const safeTitle = project.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeDescription = project.description.replace(/'/g, "\\'").replace(/"/g, '\\"');

                projectsFeed.innerHTML += `
                    <div class="p-4 card rounded-xl shadow-sm hover:shadow-md transition duration-200 border-l-4 ${isMyProject ? 'border-secondary-color' : 'border-primary-color'}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-base break-words">${project.title}</h4>
                            <span class="text-xs text-text-secondary ml-3 whitespace-nowrap">
                                ${project.createdAt ? project.createdAt.toDate().toLocaleDateString('tr-TR') : ''}
                            </span>
                        </div>
                        <p class="text-sm text-text-secondary mb-3">Paylaşan: ${project.authorNickname}.</p>
                        
                        <div class="bg-bg-default p-3 rounded-lg border border-border-color/50 mb-3">
                             <p class="text-xs font-medium text-text-secondary mb-1 flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-1 text-secondary-color"></i> Yap. Zeka Özeti:
                             </p>
                             <p class="text-sm italic text-text-default">${project.summary}</p>
                        </div>

                        <div class="flex space-x-2 mt-3">
                            <a href="${project.url}" target="_blank" class="text-xs font-semibold text-white bg-primary-color py-1.5 px-3 rounded-full hover:bg-primary-color/80 flex items-center">
                                <i data-lucide="external-link" class="w-4 h-4 mr-1"></i> Projeye Git
                            </a>
                            <button onclick="summarizeProject('${project.id}', '${safeTitle}', '${safeDescription}')" 
                                    class="text-xs font-semibold text-white bg-secondary-color py-1.5 px-3 rounded-full hover:bg-secondary-color/80 flex items-center">
                                <i data-lucide="wand-2" class="w-4 h-4 mr-1"></i> YZ Özeti Oluştur
                            </button>
                        </div>
                    </div>
                `;
            });
            // Lucide ikonlarını yeniden oluştur
            lucide.createIcons();
        };

        // --- GLOBAL ERİŞİM NOKTALARI (HTML'deki onclick için) ---
        // Modül kapsamı nedeniyle doğrudan erişilemeyen fonksiyonları window objesine atıyoruz.
        window.loadProject = loadProject;
        window.shareProject = shareProject;
        window.sendMessage = sendMessage;
        window.saveNickname = saveNickname;
        window.banUser = banUser;
        window.unbanUser = unbanUser;
        window.closeMessageModal = closeMessageModal;
        window.summarizeProject = summarizeProject;


        // --- BAŞLANGIÇ ---
        // Pencere yüklendiğinde Firebase'i başlat.
        window.onload = () => {
             // Lucide ikonlarını yükle
            lucide.createIcons();
            initFirebase();
        };

    </script>
</body>
</html>
